<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitar Adopción - Adoptante - Huellitas Felizes</title>
    <link rel="stylesheet" href="base.css">
    <link rel="stylesheet" href="solicitaradopcion.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-paw logo-icon"></i>
                <h2>Huellitas Felizes</h2>
            </div>
            
            <nav class="nav-menu">
                <a href="index.html" class="nav-link" data-page="dashboard">
                    <i class="fas fa-home"></i>
                    <span>Inicio</span>
                </a>
                <a href="veranimales.html" class="nav-link" data-page="veranimales">
                    <i class="fas fa-paw"></i>
                    <span>Ver Mascotas</span>
                </a>
                <a href="#" class="nav-link active" data-page="solicitaradopcion">
                    <i class="fas fa-heart"></i>
                    <span>Solicitar Adopción</span>
                </a>
                <a href="perfil.html" class="nav-link" data-page="perfil">
                    <i class="fas fa-user"></i>
                    <span>Mi Perfil</span>
                </a>
                <a href="#" class="nav-link logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Cerrar Sesión</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <h1>Solicitar Adopción</h1>
                </div>
                <div class="header-right">
                    <img src="../imagenes/imglogo.jpg" alt="Logo" class="logo-img" onerror="this.onerror=null; this.src='image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22 viewBox=%220 0 24 24%22><rect width=%2224%22 height=%2224%22 fill=%22%234CAF50%22/><text x=%2212%22 y=%2216%22 font-family=%22Arial%22 font-size=%2214%22 fill=%22white%22 text-anchor=%22middle%22>HF</text></svg>';">
                    <div class="user-info">
                        <span id="userName">Cargando...</span>
                    </div>
                </div>
            </header>

            <!-- Form Section -->
            <section class="animals-section">
                <div class="profile-container">
                    <h2>Formulario de Solicitud de Adopción</h2>
                    
                    <form id="solicitudForm" class="edit-profile-form">
                        <div class="edit-form-row">
                            <div class="input-group">
                                <label for="nombreMascota">Nombre de la Mascota</label>
                                <select id="nombreMascota" name="nombreMascota" required>
                                    <option value="">Selecciona una mascota</option>
                                    <!-- Las opciones se cargarán dinámicamente -->
                                </select>
                            </div>
                            
                            <div class="input-group">
                                <label for="fechaSolicitud">Fecha de Solicitud</label>
                                <input type="date" id="fechaSolicitud" name="fechaSolicitud" required>
                            </div>
                        </div>
                        
                        <div class="edit-form-row">
                            <div class="input-group">
                                <label for="tipoVivienda">Tipo de Vivienda</label>
                                <select id="tipoVivienda" name="tipoVivienda" required>
                                    <option value="">Selecciona tipo de vivienda</option>
                                    <option value="casa">Casa</option>
                                    <option value="departamento">Departamento</option>
                                    <option value="casaConPatio">Casa con patio</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>
                            
                            <div class="input-group">
                                <label for="espacioHogar">Espacio del Hogar (m²)</label>
                                <input type="number" id="espacioHogar" name="espacioHogar" placeholder="Ej: 80" required>
                            </div>
                        </div>
                        
                        <div class="edit-form-row">
                            <div class="input-group">
                                <label for="tiempoCuidado">¿Cuánto tiempo puedes dedicarle al animal?</label>
                                <select id="tiempoCuidado" name="tiempoCuidado" required>
                                    <option value="">Selecciona tiempo de cuidado</option>
                                    <option value="menos4">Menos de 4 horas diarias</option>
                                    <option value="4a6">4 a 6 horas diarias</option>
                                    <option value="mas6">Más de 6 horas diarias</option>
                                </select>
                            </div>
                            
                            <div class="input-group">
                                <label for="experiencia">¿Tienes experiencia con animales?</label>
                                <select id="experiencia" name="experiencia" required>
                                    <option value="">Selecciona experiencia</option>
                                    <option value="si">Sí</option>
                                    <option value="no">No</option>
                                    <option value="poco">Poco</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label for="motivo">Motivo de Adopción</label>
                            <textarea id="motivo" name="motivo" rows="4" placeholder="Describe por qué deseas adoptar esta mascota..." required></textarea>
                        </div>
                        
                        <div class="input-group">
                            <label for="disponibilidad">¿Estás disponible para revisiones médicas?</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="disponibilidad" name="disponibilidad" required>
                                    <span class="checkmark"></span>
                                    Acepto estar disponible para revisiones médicas y seguimiento
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn-cancelar" onclick="window.location.href='index.html'">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button type="submit" class="btn-solicitar">
                                <i class="fas fa-paper-plane"></i> Enviar Solicitud
                            </button>
                        </div>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <script src="base.js"></script>
    <script src="solicitaradopcion.js"></script>
    <script>
        // Script específico para esta página
        document.addEventListener('DOMContentLoaded', function() {
            initializeSolicitudPage();
            loadAnimalesDisponiblesForSolicitud();
        });

        function initializeSolicitudPage() {
            // Cargar nombre del usuario
            const userName = localStorage.getItem('userName') || 'Usuario';
            const userNameElement = document.getElementById('userName');
            if (userNameElement) {
                userNameElement.textContent = userName;
            }
            
            // Establecer fecha actual por defecto
            const today = new Date().toISOString().split('T')[0];
            const fechaSolicitud = document.getElementById('fechaSolicitud');
            if (fechaSolicitud) {
                fechaSolicitud.value = today;
            }
            
            // Configurar el formulario
            setupSolicitudForm();
        }

        // Configurar el formulario
        function setupSolicitudForm() {
            const solicitudForm = document.getElementById('solicitudForm');
            
            if (solicitudForm) {
                solicitudForm.addEventListener('submit', handleSubmitSolicitud);
            }
        }

        // Cargar animales disponibles para solicitud (CORREGIDO EL NOMBRE)
        async function loadAnimalesDisponiblesForSolicitud() {
            try {
                // Mostrar estado de carga
                showLoadingState();
                
                // Cargar datos de animales desde la base de datos - CORREGIDO EL NOMBRE
                const animalsData = await fetchAnimalesDisponiblesFromDB();
                populateAnimalesSelect(animalsData);
                
            } catch (error) {
                console.error('Error loading animals for solicitud:', error);
                // Mostrar mensaje de error claro
                showErrorState(error.message);
            }
        }

        // Función para mostrar estado de carga
        function showLoadingState() {
            const select = document.getElementById('nombreMascota');
            if (select) {
                select.innerHTML = '<option value="">Cargando animales...</option>';
            }
        }

        // Función para mostrar errores
        function showErrorState(errorMessage) {
            const select = document.getElementById('nombreMascota');
            if (select) {
                select.innerHTML = `<option value="">Error: ${errorMessage}</option>`;
            }
        }

        // Función para cargar animales desde la base de datos - CORREGIDO EL NOMBRE
        async function fetchAnimalesDisponiblesFromDB() {
            try {
                const response = await fetch('../backend/ver_animales_disponibles.php');
                if (!response.ok) {
                    throw new Error(`Error de servidor: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    return data.data;
                } else {
                    throw new Error(data.message || 'Error desconocido');
                }
                
            } catch (error) {
                console.error('Error fetching animals for solicitud:', error);
                throw error;
            }
        }

        // Función para poblar el select de animales
        function populateAnimalesSelect(animalsData) {
            const select = document.getElementById('nombreMascota');
            
            if (select && animalsData && Array.isArray(animalsData) && animalsData.length > 0) {
                select.innerHTML = '<option value="">Selecciona una mascota</option>';
                
                animalsData.forEach(animal => {
                    const option = document.createElement('option');
                    option.value = animal.id;
                    option.textContent = `${animal.nombre} (${animal.tipo})`;
                    select.appendChild(option);
                });
            } else if (select && animalsData && Array.isArray(animalsData) && animalsData.length === 0) {
                // Si hay respuesta pero sin datos
                select.innerHTML = '<option value="">No hay animales disponibles</option>';
            } else if (select) {
                // Si no hay datos válidos
                select.innerHTML = '<option value="">Error al cargar animales</option>';
            }
        }

        // Manejar el envío del formulario
        async function handleSubmitSolicitud(e) {
            e.preventDefault();
            
            // Validar que se haya seleccionado una mascota
            const nombreMascota = document.getElementById('nombreMascota');
            if (!nombreMascota || !nombreMascota.value) {
                showNotification('Por favor, selecciona una mascota', 'error');
                return;
            }
            
            // Validar que se haya aceptado la disponibilidad
            const disponibilidad = document.getElementById('disponibilidad');
            if (!disponibilidad || !disponibilidad.checked) {
                showNotification('Debes aceptar estar disponible para revisiones médicas', 'error');
                return;
            }
            
            try {
                // Recoger datos del formulario
                const formData = new FormData();
                
                const fields = ['nombreMascota', 'fechaSolicitud', 'tipoVivienda', 'espacioHogar', 'tiempoCuidado', 'experiencia', 'motivo', 'disponibilidad'];
                fields.forEach(field => {
                    const element = document.getElementById(field);
                    if (element) {
                        // Para checkboxes, usar checked en lugar de value
                        if (element.type === 'checkbox') {
                            formData.append(field, element.checked);
                        } else {
                            formData.append(field, element.value);
                        }
                    }
                });
                
                // Agregar información del usuario
                formData.append('user_id', localStorage.getItem('userId') || 1);
                
                const response = await fetch('../backend/solicitar_adopcion.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Solicitud de adopción enviada exitosamente', 'success');
                    // Limpiar formulario
                    solicitudForm.reset();
                    // Establecer fecha actual de nuevo
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('fechaSolicitud').value = today;
                } else {
                    showNotification(result.message || 'Error al enviar la solicitud', 'error');
                }
                
            } catch (error) {
                console.error('Error submitting solicitud:', error);
                showNotification('Error de conexión al enviar la solicitud', 'error');
            }
        }
    </script>
</body>
</html>